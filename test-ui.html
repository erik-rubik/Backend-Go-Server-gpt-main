<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Backend Server Test UI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        .input-group input, .input-group button {
            padding: 8px 12px;
            margin: 2px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .input-group input {
            width: 200px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .disconnect {
            background-color: #dc3545;
        }
        .disconnect:hover {
            background-color: #c82333;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.round-active {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: monospace;
            font-size: 12px;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            background-color: white;
        }
        .message.system {
            border-left-color: #28a745;
        }
        .message.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .message.winner {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        .api-response {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .flex-container {
            display: flex;
            gap: 20px;
        }
        .flex-item {
            flex: 1;
        }
        .health-good {
            color: #28a745;
            font-weight: bold;
        }
        .health-bad {
            color: #dc3545;
            font-weight: bold;
        }
        .timestamp {
            color: #6c757d;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Go Backend Server Test UI</h1>
        <p>This test UI allows you to interact with your WebSocket server, test round-based messaging, and examine the API endpoints.</p>
        
        <div class="flex-container">
            <div class="flex-item">
                <!-- WebSocket Connection Section -->
                <div class="section">
                    <h3>WebSocket Connection</h3>
                    <div class="input-group">
                        <label>Server URL:</label>
                        <input type="text" id="serverUrl" value="ws://localhost:8080/ws" />
                        <button onclick="detectServerUrl()">Auto-detect</button>
                    </div>
                    <div class="input-group">
                        <label>Username:</label>
                        <input type="text" id="username" value="testuser" />
                    </div>
                    <div class="input-group">
                        <button id="connectBtn" onclick="connect()">Connect</button>
                        <button id="disconnectBtn" onclick="disconnect()" disabled class="disconnect">Disconnect</button>
                    </div>
                    <div id="connectionStatus" class="status disconnected">Disconnected</div>
                    <div id="roundStatus" class="status">Round Status: Unknown</div>
                </div>

                <!-- Messaging Section -->
                <div class="section">
                    <h3>Send Message</h3>
                    <div class="input-group">
                        <label>Message:</label>
                        <input type="text" id="messageInput" placeholder="Enter your message" disabled />
                        <button id="sendBtn" onclick="sendMessage()" disabled>Send</button>
                    </div>
                    <p><small>Note: You can only send one message per round, and only during active rounds.</small></p>
                </div>
            </div>

            <div class="flex-item">
                <!-- API Testing Section -->
                <div class="section">
                    <h3>API Testing</h3>
                    <div class="input-group">
                        <label>Health Check:</label>
                        <button onclick="checkHealth()">Check /health</button>
                    </div>
                    <div class="input-group">
                        <label>Round ID:</label>
                        <input type="text" id="roundId" placeholder="Enter round ID" />
                        <button onclick="fetchRoundData()">Fetch /api/rounds/{id}</button>
                    </div>
                    <div id="apiResponse" class="api-response">API responses will appear here...</div>
                </div>
            </div>
        </div>

        <!-- Messages Display -->
        <div class="section">
            <h3>Real-time Messages</h3>
            <div id="messages" class="messages">WebSocket messages will appear here...</div>
            <button onclick="clearMessages()">Clear Messages</button>
        </div>

        <!-- Instructions -->
        <div class="section">
            <h3>How to Use This Test UI</h3>
            <ol>
                <li><strong>Start your Go server:</strong> Make sure your backend server is running on port 8080</li>
                <li><strong>Connect:</strong> Enter a username and click "Connect" to establish WebSocket connection</li>
                <li><strong>Wait for round:</strong> The server runs rounds automatically. Wait for a "Round started" message</li>
                <li><strong>Send messages:</strong> During active rounds, send messages to participate</li>
                <li><strong>View winner:</strong> At the end of each round, a winner is announced</li>
                <li><strong>Test API:</strong> Use the API section to check health and fetch round data</li>
                <li><strong>Multiple clients:</strong> Open this page in multiple tabs with different usernames to simulate multiple users</li>
            </ol>
        </div>
    </div>

    <script>
        let socket = null;
        let isConnected = false;
        let currentRoundId = null;
        let roundActive = false;

        function connect() {
            const serverUrl = document.getElementById('serverUrl').value;
            const username = document.getElementById('username').value;
            
            if (!username.trim()) {
                alert('Please enter a username');
                return;
            }

            // Validate username (3-20 chars, alphanumeric + underscore)
            if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
                alert('Invalid username: must be 3-20 characters, alphanumeric and underscore only');
                return;
            }

            const wsUrl = `${serverUrl}?username=${encodeURIComponent(username)}`;
            
            try {
                socket = new WebSocket(wsUrl);
                
                socket.onopen = function(event) {
                    isConnected = true;
                    updateConnectionStatus('Connected', 'connected');
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    addMessage('SYSTEM', 'Connected to server', 'system');
                };
                
                socket.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        handleWebSocketMessage(message);
                    } catch (e) {
                        addMessage('ERROR', 'Failed to parse message: ' + event.data, 'error');
                    }
                };
                
                socket.onclose = function(event) {
                    isConnected = false;
                    updateConnectionStatus('Disconnected', 'disconnected');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    document.getElementById('messageInput').disabled = true;
                    document.getElementById('sendBtn').disabled = true;
                    addMessage('SYSTEM', `Connection closed (Code: ${event.code})`, 'system');
                };
                
                socket.onerror = function(error) {
                    addMessage('ERROR', 'WebSocket error occurred', 'error');
                };
                
            } catch (error) {
                addMessage('ERROR', 'Failed to connect: ' + error.message, 'error');
            }
        }

        function disconnect() {
            if (socket) {
                socket.close();
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('Please enter a message');
                return;
            }

            if (!isConnected) {
                alert('Not connected to server');
                return;
            }

            if (!roundActive) {
                alert('No active round. Wait for the next round to start.');
                return;
            }

            const clientMessage = {
                version: "1.0",
                type: "chat",
                username: document.getElementById('username').value,
                data: message
            };

            try {
                socket.send(JSON.stringify(clientMessage));
                messageInput.value = '';
                addMessage('SENT', `You: ${message}`, 'message');
            } catch (error) {
                addMessage('ERROR', 'Failed to send message: ' + error.message, 'error');
            }
        }

        function handleWebSocketMessage(message) {
            const timestamp = new Date().toISOString();
            
            switch (message.type) {
                case 'round_start':
                    roundActive = true;
                    currentRoundId = message.data;
                    updateRoundStatus(`Round Active (ID: ${currentRoundId})`, 'round-active');
                    addMessage('ROUND', `Round started! ID: ${currentRoundId}`, 'system');
                    break;
                    
                case 'round_end':
                    roundActive = false;
                    updateRoundStatus('Round Ended', 'disconnected');
                    addMessage('ROUND', 'Round ended', 'system');
                    break;
                    
                case 'chat':
                    addMessage('CHAT', `${message.username}: ${message.data}`, 'message');
                    break;
                    
                case 'winner':
                    addMessage('WINNER', `🏆 Winner: ${message.username} - "${message.data}"`, 'winner');
                    break;
                    
                case 'error':
                    addMessage('ERROR', `Error (${message.error_code}): ${message.data}`, 'error');
                    break;
                    
                default:
                    addMessage('UNKNOWN', `Unknown message type: ${message.type}, data: ${JSON.stringify(message)}`, 'message');
            }
        }

        function updateConnectionStatus(status, className) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = status;
            statusDiv.className = `status ${className}`;
        }

        function updateRoundStatus(status, className) {
            const statusDiv = document.getElementById('roundStatus');
            statusDiv.textContent = status;
            statusDiv.className = `status ${className}`;
        }

        function addMessage(type, content, className) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            messageDiv.className = `message ${className}`;
            messageDiv.innerHTML = `<span class="timestamp">[${timestamp}]</span> <strong>${type}:</strong> ${content}`;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('apiResponse').textContent = `Error: ${error.message}`;
            }
        }

        async function fetchRoundData() {
            const roundId = document.getElementById('roundId').value.trim();
            
            if (!roundId) {
                alert('Please enter a round ID');
                return;
            }

            try {
                const response = await fetch(`/api/rounds/${encodeURIComponent(roundId)}`);
                const data = await response.json();
                document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('apiResponse').textContent = `Error: ${error.message}`;
            }
        }

        // Allow sending message with Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Add some helpful info on page load
        window.onload = function() {
            // Auto-detect server URL based on current page
            detectServerUrl();
            
            addMessage('INFO', 'Welcome to the Go Backend Server Test UI', 'system');
            addMessage('INFO', 'Server URL auto-detected. Adjust if needed.', 'system');
            addMessage('INFO', 'Enter a username and click Connect to start testing', 'system');
        };

        function detectServerUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const wsUrl = `${protocol}//${host}/ws`;
            document.getElementById('serverUrl').value = wsUrl;
        }
    </script>
</body>
</html>
